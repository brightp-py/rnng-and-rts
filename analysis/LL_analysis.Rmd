---
title: "Lisa's Natural Stories RNNG Surprisals Analysis"
author: "Lisa Levinson"
date: '2022-04-01'
output:
  md_document:
    variant: gfm
---

# Preliminaries

## Load packages

```{r setup, message = FALSE, warning = FALSE}
here::i_am("analysis/LL_analysis.Rmd")
library(here)
library(tidyverse) # for data processing
library(knitr)
library(lmerTest)
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
df_rnng <- read_tsv(here("data/ns-results.tsv"))
df_lstm <- read_tsv(here("data/naturalstories.output"))
df_ids <- read_tsv(here("data/ids.tsv"))
df_rts <- read_tsv(here("data/processed_RTs.tsv"))
```
 
 
## Clean up data and join RNNG with IDs

```{r}
# df_rnng <- df_rnng %>% 
#   rename(word_num = token_id,
#          leaf_surp = ind,
#          brn_surp = brn)

# df_lstm <- df_lstm %>% 
#   rename(word_num = token_id,
#          lstm_surp = surp)

df_lstm <- df_lstm %>%
  rename(lstm_surp = surp)

# df_ids <- df_ids %>% 
# rename(story = TokenItem,
#          zone = TokenZone,
#          word_num = TreeWord,
#          sent = TreeInd,
#          word = Component) 

# there are some missing from the RNNG surprisals - cutting those out

df_surp <- left_join(df_ids, df_rnng, by = c("sent", "word_num"), suffix = c("", ".duplicate")) %>%
 	 select(-ends_with(".duplicate")) %>% 
      mutate(zone = if_else(story == 1, zone + 1, zone))

df_surp <- left_join(df_surp, df_lstm, by = c("sent", "word_num"), suffix = c("", ".duplicate")) %>%
 	 select(-ends_with(".duplicate"))

df_missing_rnng <- filter(df_surp, is.na(leaf_surp))
df_surp <- filter(df_surp, !is.na(leaf_surp))

```

## Collapse rows from same zone, sum surprisals over zone

```{r}

df_surp <- df_surp %>% 
  group_by(story, zone, sent) %>% 
  summarize(
    # add column showing words, word_nums, depths, indices that were combined
    word_nums = str_c(word_num, collapse = "; "),
    words = str_c(word, collapse = "_"),
    indices = str_c(Index, collapse = "; "),
    depths = str_c(depth, collapse = "; "),
    leaf_surp = sum(leaf_surp),
    brn_surp = sum(brn_surp),
    lstm_surp = sum(lstm_surp),
    total_words = n()
  )

df_surp_zone_count <- df_surp %>% 
  group_by(story) %>% 
  count()
```

## Pulling in RTs

Count the item/zone rows to see if it matches the surprisal dataframe. 

```{r}

df_rts <- rename(df_rts, story = item)


df_rt_count <- df_rts %>% 
  group_by(story, zone) %>% 
  count()

df_zone_count <- df_rt_count %>% 
  group_by(story) %>% 
  count()


# this is a join just to check for items with RTs but without surprisals

df_missing_surp <- left_join(df_rt_count, df_surp, by = c("story", "zone")) %>% 
  filter(is.na(indices))


```

create joined RT with surprisal dataframe and remove rows where there is no surprisal

```{r}
df_rtsurp <- left_join(df_rts, df_surp, by = c("story", "zone")) %>% 
  filter(!is.na(leaf_surp)) %>% 
  arrange(story, zone)

```

count trials per story/zone

```{r}
df_words <- df_rtsurp %>% 
  group_by(story, zone, word) %>% 
  count()
```
 
add a column with story/zone identifier

```{r}
df_rtsurp <- df_rtsurp %>% 
  mutate(story_zone  = str_c(story, zone, sep = "_"))
  
```

summarize by story/zone means 

```{r}
df_zonemeans <- df_rtsurp %>% 
  group_by(story_zone, lstm_surp) %>% 
  summarize(
    meanRT = mean(RT, na.rm = TRUE)
  )

```

which ones are over 750ms mean?

```{r}
df_highmeans <- df_zonemeans %>% 
  filter(meanRT > 750)

```

 
 
 
# plot

summarize by story/zone means 

```{r}

p_rtsurp <- ggplot(
 df_zonemeans,
  aes(y = meanRT, x = lstm_surp)
) +
  geom_point(
    stat = "identity"
  ) +
  geom_smooth(method = lm, level = 0.99) +
  ggtitle("RT * surprisal")
p_rtsurp
```

plot without means over 750 (mostly last word in story)

```{r}

p_lower <- ggplot(
 filter(df_zonemeans, meanRT < 750),
  aes(y = meanRT, x = lstm_surp)
) +
  geom_point(
    stat = "identity"
  ) +
  geom_smooth(method = lm, level = 0.99) +
  ggtitle("RT * surprisal (means under 750)") +
  xlab("LSTM Surprisal") + 
  ylab("Mean Reading Time")

imgfile <- here("imgs/rt_v_lstm.png")
ggsave(file=imgfile, plot=p_lower, width=20, height=10, unit="cm")
p_lower
```

# stats

```{r}
m_1 <- lmer(log(RT) ~ lstm_surp + (1|WorkerId), data = df_rtsurp)
summary(m_1)
```

