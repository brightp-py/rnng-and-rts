---
title: "Lisa's Natural Stories RNNG Surprisals Analysis"
author: "Lisa Levinson"
date: '2022-04-01'
output:
  md_document:
    variant: gfm
---

# Preliminaries

## Load packages

```{r setup, message = FALSE, warning = FALSE}
here::i_am("analysis/LL_analysis.Rmd")
library(here)
library(tidyverse) # for data processing
library(knitr)
library(lmerTest)
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
df_rnng <- read_tsv(here("analysis/data/ns-results.tsv"))
df_ids <- read_tsv(here("analysis/data/ids.tsv"))
df_rts <- read_tsv(here("data/processed_RTs.tsv"))
```
 
 
## Clean up data and join RNNG with IDs

```{r}
df_rnng <- df_rnng %>% 
  rename(story = item,
         word_num = token_id,
         ind_surp = ind,
         brn_surp = brn)

df_ids <- df_ids %>% 
  rename(story = TokenItem,
         zone = TokenZone,
         word_num = TreeWord,
         sent = TreeInd,
         word = Component) 

# there are some missing from the RNNG surprisals - cutting those out

df_surp <- left_join(df_ids, df_rnng, by = c("sent", "word_num"), suffix = c("", ".duplicate")) %>%
 	 select(-ends_with(".duplicate")) %>% 
      mutate(zone = if_else(story == 1, zone + 1, zone)) 

df_missing_rnng <- filter(df_surp, is.na(ind_surp))
df_surp <- filter(df_surp, !is.na(ind_surp))

```

## Collapse rows from same zone, sum surprisals over zone

```{r}

df_surp <- df_surp %>% 
  group_by(story, zone, sent) %>% 
  summarize(
    # add column showing words, word_nums, depths, indices that were combined
    word_nums = str_c(word_num, collapse = "; "),
    words = str_c(word, collapse = "_"),
    indices = str_c(Index, collapse = "; "),
    depths = str_c(depth, collapse = "; "),
    ind_surp = sum(ind_surp),
    brn_surp = sum(brn_surp),
    total_words = n()
  )

df_surp_zone_count <- df_surp %>% 
  group_by(story) %>% 
  count()
```

## Pulling in RTs

Count the item/zone rows to see if it matches the surprisal dataframe. 

```{r}

df_rts <- rename(df_rts, story = item)


df_rt_count <- df_rts %>% 
  group_by(story, zone) %>% 
  count()

df_zone_count <- df_rt_count %>% 
  group_by(story) %>% 
  count()


# this is a join just to check for items with RTs but without surprisals

df_missing_surp <- left_join(df_rt_count, df_surp, by = c("story", "zone")) %>% 
  filter(is.na(indices))


```

create joined RT with surprisal dataframe and remove rows where there is no surprisal

```{r}
df_rtsurp <- left_join(df_rts, df_surp, by = c("story", "zone")) %>% 
  filter(!is.na(ind_surp)) %>% 
  arrange(story, zone)

```

count trials per story/zone

```{r}
df_words <- df_rtsurp %>% 
  group_by(story, zone, word) %>% 
  count()
```
 
add a column with story/zone identifier

```{r}
df_rtsurp <- df_rtsurp %>% 
  mutate(story_zone  = str_c(story, zone, sep = "_"))
  
```

summarize by story/zone means 

```{r}
df_zonemeans <- df_rtsurp %>% 
  group_by(story_zone, ind_surp) %>% 
  summarize(
    meanRT = mean(RT, na.rm = TRUE)
  )

```
 
# plot

summarize by story/zone means 

```{r}

p_rtsurp <- ggplot(
 df_zonemeans,
  aes(y = meanRT, x = ind_surp)
) +
  geom_point(
    stat = "identity"
  ) +
  geom_smooth(method = lm, level = 0.99) +
  ggtitle("title")
p_rtsurp
```


# stats

```{r}
m_1 <- lmer(log(RT) ~ ind_surp + (1|WorkerId), data = df_rtsurp)
summary(m_1)
```

