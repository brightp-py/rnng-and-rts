---
title: "Lisa's Natural Stories RNNG Surprisals Analysis"
author: "Lisa Levinson"
date: '2022-04-01'
output:
  md_document:
    variant: gfm
---

# Preliminaries

## Load packages

```{r setup, message = FALSE, warning = FALSE}
here::i_am("analysis/LL_analysis.Rmd")
library(here)
library(tidyverse) # for data processing
library(knitr)
library(lmerTest)
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
df_rnng <- read_tsv(here("data/naturalstories_rnng.output"))
df_lstm <- read_tsv(here("data/naturalstories_lstm.output"))
df_ids <- read_tsv(here("data/ids.tsv"))
df_rts <- read_tsv(here("data/processed_RTs.tsv"))
```
 
 
## Clean up data and join RNNG with IDs

```{r}

col_names <- c("sent", "sent_pos")
suffixes <- c("", ".duplicate")

df_surp <- left_join(df_ids, df_rnng, by = col_names, suffix = suffixes) %>%
    select(-ends_with(".duplicate")) %>%
    mutate(story_pos = if_else(story == 1, story_pos + 1, story_pos))

df_surp <- left_join(df_surp, df_lstm, by = col_names, suffix = suffixes) %>%
    select(-ends_with(".duplicate"))

df_missing_rnng <- filter(df_surp, is.na(leaf_surp))
df_surp <- filter(df_surp, !is.na(leaf_surp))
```

## Collapse rows from same zone, sum surprisals over zone

```{r}

df_surp <- df_surp %>%
    group_by(story, story_pos, sent) %>%
    summarize(
        positions = str_c(sent_pos, collapse = "; "),
        word = str_c(word, collapse = "_"),
        indices = str_c(index, collapse = "; "),
        depths = str_c(depth, collapse = "; "),
        leaf_surp = sum(leaf_surp),
        branch_surp = sum(branch_surp),
        lstm_surp = sum(lstm_surp),
        total_words = n()
    )

df_surp_zone_count <- df_surp %>%
    group_by(story) %>%
    count()
```

## Pulling in RTs

Count the item/zone rows to see if it matches the surprisal dataframe. 

```{r}

df_rt_count <- df_rts %>%
    group_by(story, story_pos) %>%
    count()

df_zone_count <- df_rt_count %>%
    group_by(story) %>%
    count()

# this is a join just to check for items with RTs but without surprisals
df_missing_surp <-
    left_join(df_rt_count, df_surp, by = c("story", "story_pos")) %>%
    filter(is.na(indices))
```

create joined RT with surprisal dataframe and remove rows where there is no surprisal

```{r}

df_rtsurp <- left_join(df_rts, df_surp, by = c("story", "story_pos")) %>%
    filter(!is.na(leaf_surp)) %>%
    arrange(story, story_pos)
```

count trials per story/zone

```{r}

df_words <- df_rtsurp %>%
    group_by(story, story_pos, word) %>%
    count()
```

add word length and frequency columns

```{r}

df_rtsurp$word_length <- nchar(df_rtsurp$word.x)

df_wordfreq <- read_tsv(here("data/wordfreq.tsv"))
df_rtsurp <- df_rtsurp %>%
  left_join(df_wordfreq, by = c("word.x" = "word"))
df_rtsurp[is.na(df_rtsurp)] <- df_wordfreq$freq[df_wordfreq$word == "<unk>"]
```
 
add a column with story/zone identifier

```{r}

df_rtsurp <- df_rtsurp %>%
    mutate(story_zone = str_c(story, story_pos, sep = "_"))
```

summarize by story/zone means 

```{r}

df_zonemeans <- df_rtsurp %>%
    group_by(story_zone, leaf_surp, freq) %>%
    summarize(
        mean_rt = mean(rt, na.rm = TRUE)
    )
```

which ones are over 750ms mean?

```{r}

df_highmeans <- df_zonemeans %>%
    filter(mean_rt > 750)
```
 
 
# plot

summarize by story/zone means 

```{r}

p_rtsurp <- ggplot(
 df_zonemeans,
  aes(y = mean_rt, x = lstm_surp)
) +
  geom_point(
    stat = "identity"
  ) +
  geom_smooth(method = lm, level = 0.99) +
  ggtitle("RT * surprisal")
p_rtsurp
```

plot without means over 750 (mostly last word in story)

```{r}

p_lower <- ggplot(
 filter(df_zonemeans, mean_rt < 750),
  aes(y = mean_rt, x = freq)
) +
  geom_point(
    stat = "identity"
  ) +
  geom_smooth(method = lm, level = 0.99) +
  ggtitle("RT * surprisal (means under 750)") +
  xlab("LSTM Surprisal") +
  ylab("Mean Reading Time")

imgfile <- here("imgs/rt_v_lstm.png")
ggsave(file = imgfile, plot = p_lower, width = 20, height = 10, unit = "cm")
p_lower
```

```{r}
rnng_v_lstm <- ggplot(
  df_surp,
  aes(y = branch_surp, x = lstm_surp, color = -depth)
) +
  geom_point(
    stat = "identity"
  ) +
  geom_smooth(method = lm, level = 0.99) +
  ggtitle("LSTM Surprisal * RNNG Surprisal") +
  xlab("LSTM Surprisal") +
  ylab("Branch Surprisal")
imgfile <- here("imgs/branch_v_leaf.png")
ggsave(file = imgfile, plot = rnng_v_lstm, width = 20, height = 10,
  unit = "cm")
rnng_v_lstm
```

get the words with the greatest difference between LSTM and RNNG results

```{r}

df_surp[order(df_surp$leaf_surp / df_surp$lstm_surp),
  c("word", "story", "story_pos", "lstm_surp", "leaf_surp")] %>%
  filter(lstm_surp > 12 && lstm_surp < 16 && leaf_surp < 7) %>%
  write.csv(file = here("./data/leafy_words.tsv"), quote = FALSE, sep = '\t')
```

# stats

```{r}
m_1 <- lmer(rt ~ word_length + branch_surp + (1 | worker_id), data = df_rtsurp)
summary(m_1)
```

