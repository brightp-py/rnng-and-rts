---
title: "Ridge Regression RNNG Natural Stories Analysis"
author: "Brighton Pauli"
date: "2022-06-15"
output:
    md_document:
        variant: gfm
---

# Preliminaries

## Load packages

```{r setup, message = FALSE}

here::i_am("analysis/Ridge_analysis.Rmd")
library(here)
library(tidyverse)
library(glmnet)
```

## Load data

```{r}

df_rnng <- read_tsv(here("data/naturalstories_rnng.output"))
df_lstm <- read_tsv(here("data/naturalstories_lstm.output"))
df_ids <- read_tsv(here("data/ids.tsv"))
df_rts <- read_tsv(here("data/processed_RTs.tsv"))
```

## Clean up data and join RNNG with IDs

```{r}

col_names <- c("sent", "sent_pos")
suffixes <- c("", ".duplicate")

df_surp <- left_join(df_ids, df_rnng, by = col_names, suffix = suffixes) %>%
    select(-ends_with(".duplicate")) %>%
    mutate(story_pos = if_else(story == 1, story_pos + 1, story_pos))

df_surp <- left_join(df_surp, df_lstm, by = col_names, suffix = suffixes) %>%
    select(-ends_with(".duplicate"))

df_missing_rnng <- filter(df_surp, is.na(leaf_surp))
df_surp <- filter(df_surp, !is.na(leaf_surp))
```

## Collapse rows from same story_pos, sum suprisals over story_pos

```{r}

df_surp <- df_surp %>%
    group_by(story, story_pos, sent) %>%
    summarize(
        positions = str_c(sent_pos, collapse = "; "),
        words = str_c(word, collapse = "_"),
        indices = str_c(index, collapse = "; "),
        depths = str_c(depth, collapse = "; "),
        leaf_surp = sum(leaf_surp),
        branch_surp = sum(branch_surp),
        lstm_surp = sum(lstm_surp),
        total_words = n()
    )

df_surp_zone_count <- df_surp %>%
    group_by(story) %>%
    count()
```

## Pulling in RTs

Count the item/story_pos rows to see if it matches the surprisal dataframe.

```{r}

df_rt_count <- df_rts %>%
    group_by(story, story_pos) %>%
    count()

df_zone_count <- df_rt_count %>%
    group_by(story) %>%
    count()

# this is a join just to check for items with RTs but without surprisals
df_missing_surp <-
    left_join(df_rt_count, df_surp, by = c("story", "story_pos")) %>%
    filter(is.na(indices))
```

Create joined reading times with surprisal dataframe and remove rows where 
there is no surprisal.

```{r}

df_rtsurp <- left_join(df_rts, df_surp, by = c("story", "story_pos")) %>%
    filter(!is.na(leaf_surp)) %>%
    arrange(story, story_pos)
```

Count trials per story/zone.

```{r}

df_words <- df_rtsurp %>%
    group_by(story, story_pos, word) %>%
    count()
```

Add a column with story/zone identifier.

```{r}

df_rtsurp <- df_rtsurp %>%
    mutate(story_zone = str_c(story, story_pos, sep = "_"))
```

Summarize by story/zone means.

```{r}

df_zonemeans <- df_rtsurp %>%
    group_by(story_zone, lstm_surp) %>%
    summarize(
        mean_rt = mean(rt, na.rm = TRUE)
    )
```

Which ones are over 750ms mean?

```{r}

df_highmeans <- df_zonemeans %>%
    filter(mean_rt > 750)
```


# Ridge Regression

Load x and y axes.

```{r}

y <- log(df_rtsurp$rt)
x <- data.matrix(df_rtsurp[, c("lstm_surp", "leaf_surp")])
```

Find best value for lambda.

```{r}

cv_model <- cv.glmnet(x, y, alpha = 0)
best_lambda <- cv_model$lambda.min
best_lambda
```

Analyze the model.

```{r}

best_model <- glmnet(x, y, alpha = 0, lambda = best_lambda)
coef(best_model)

plot(best_model, xvar = "lambda")

y_predicted <- predict(best_model, s = best_lambda, newx = x)

sst <- sum((y - mean(y))^2)
sse <- sum((y_predicted - y)^2)

rsq <- 1 - sse / sst
rsq
```
